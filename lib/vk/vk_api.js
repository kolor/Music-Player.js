function vk_api(api_secret,oninit){var vk_api_initializer="http://vk.com/js/xd_connection.js";var vk_api_md5="http://vk.com/js/lib/md5.js";var ckpref="__vkjsapi_";var params_list=["api_url","api_id","user_id","group_id","viewer_id","is_app_user","viewer_type","auth_key","referrer","language","api_result","api_settings","parent_language","lc_name"];var msg_install='Для работы приложения его необходимо <a href="#" id="vk_api_msga">установить</a>';var msg_settings='Для работы приложения необходимо установить требуемые <a href="#" id="vk_api_msga">настройки</a>';var onfailure=null;var api_version="2.0";var test_mode=false;var callbacks={};var cb_index=0;var this_proxy=this;this.SETT_NOTIFY=1;this.SETT_FRIENDS=2;this.SETT_PHOTOS=4;this.SETT_AUDIO=8;this.SETT_OFFER=32;this.SETT_QUESTIONS=64;this.SETT_WIKI=128;this.SETT_MENU=256;this.SETT_WALL=512;this.SETT_STATUS=1024;this.params={};function sortByKey(obj){var keys=new Array();for(var k in obj){keys.push(k)}keys.sort();var sortedObj={};for(var i=0;i<keys.length;i++){sortedObj[keys[i]]=obj[keys[i]]}return sortedObj}function requestScript(url){var script=document.createElement("script");script.type="text/javascript";script.src=url;document.getElementsByTagName("head")[0].appendChild(script)}function decodeSecret(api_secret){if(api_secret.substring(0,4)=="sx--"){var api_secret_decoded="";var char_code="";for(var i=4;i<api_secret.length;i++){if(api_secret.charAt(i)!="l"){char_code+=api_secret.charAt(i)}else{api_secret_decoded+=String.fromCharCode(parseInt(char_code)+31);char_code=""}}return api_secret_decoded}else{return api_secret}}function addEvent(obj,eventType,callback){useCapture=false;if(arguments.length>2){useCapture=arguments[2]}if(typeof obj.addEventListener!="undefined"){obj.addEventListener(eventType,callback,useCapture);return true}else{if(typeof obj.attachEvent!="undefined"){return obj.attachEvent("on"+eventType,callback)}}}function getcookie(name){if(document.cookie.length>0){c_start=document.cookie.indexOf(name+"=");if(c_start!=-1){c_start=c_start+name.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1){c_end=document.cookie.length}return unescape(document.cookie.substring(c_start,c_end))}}return undefined}function setcookie(name,value){document.cookie=name+"="+escape(value)}function loadParams(url){VK.loadParams(document.location.href);if(typeof VK.params.api_id!="undefined"){this_proxy.params=VK.params;for(var p in params_list){if(typeof this_proxy.params[params_list[p]]!="undefined"){setcookie(ckpref+params_list[p],this_proxy.params[params_list[p]])}}}else{this_proxy.params={};for(var p in params_list){this_proxy.params[params_list[p]]=getcookie(ckpref+params_list[p]);if(typeof this_proxy.params[params_list[p]]=="undefined"){delete this_proxy.params[params_list[p]]}}}}function showMessage(msg){var settings=-1;if(arguments.length>1){settings=arguments[1]}if(document.getElementById("vk_api_msgbox")==null){document.getElementsByTagName("body")[0].innerHTML+='<div id="vk_api_msgbox" style="position: absolute;width: 100%; height: 100%;margin: 0; padding: 50px 0 0 0;border-top: #dbe2e8 1px solid;top: 0; left: 0;z-index: 100;background: white; color: gray;font-size:12px;text-align:center;">'+msg+"</div>"}else{document.getElementById("vk_api_msgbox").innerHTML=msg;document.getElementById("vk_api_msgbox").style.display="block"}addEvent(document.getElementById("vk_api_msga"),"click",function(){if(settings>=0){this_proxy.external.showSettingsBox(settings)}else{this_proxy.external.showInstallBox()}},true)}function hideMessage(){if(document.getElementById("vk_api_msgbox")!=null){document.getElementById("vk_api_msgbox").style.display="none"}}this.makeInstall=function(){var appInstalled=null;if(arguments.length>0){appInstalled=arguments[0]}if(this_proxy.params.is_app_user!=1){showMessage(msg_install);this_proxy.external.showInstallBox();this_proxy.addCallback("onApplicationAdded",function(){this_proxy.params.is_app_user=1;hideMessage();if(appInstalled!=null){appInstalled()}})}else{if(appInstalled!=null){appInstalled()}}};this.makeSettings=function(settings){if((this_proxy.params.api_settings&settings)!=settings){showMessage(msg_settings,settings);this_proxy.external.showSettingsBox(settings)}this_proxy.addCallback("onSettingsChanged",function(new_settings){this_proxy.params.api_settings=new_settings;if((this_proxy.params.api_settings&settings)==settings){hideMessage()}})};this.call=function(method){var onData=null;if((arguments.length>=2)&&(typeof arguments[1]=="function")){onData=arguments[1]}else{if((arguments.length>=3)&&(typeof arguments[2]=="function")){onData=arguments[2]}}var cb_name=ckpref+"cbfunk_"+(++cb_index);window[cb_name]=function(json){if(onData!=null){onData(json)}};var parameters={};if((arguments.length>=2)&&(typeof arguments[1]=="object")){parameters=arguments[1]}parameters.api_id=this_proxy.params.api_id;parameters.v=api_version;parameters.format="json";parameters.callback=cb_name;if(test_mode){parameters.test_mode="1"}parameters.method=method;parameters=sortByKey(parameters);var sig=this_proxy.params.viewer_id;for(var k in parameters){if(typeof parameters[k]=="object"){sig+=k+"="+parameters[k].join(",")}else{sig+=k+"="+parameters[k]}}sig+=decodeSecret(api_secret);parameters.sig=MD5(sig);var url=this_proxy.params.api_url+"?";for(var k in parameters){url+=k+"="+encodeURIComponent(parameters[k])+"&"}requestScript(url)};if((arguments.length>=3)&&(typeof arguments[2]=="function")){onfailure=arguments[2]}if((arguments.length>=3)&&(typeof arguments[2]=="boolean")){test_mode=arguments[2]}else{if((arguments.length>=4)&&(typeof arguments[3]=="boolean")){test_mode=arguments[3]}}requestScript(vk_api_md5);requestScript(vk_api_initializer);var VKLOAD_intervel=setInterval(vkapiInit,100);function vkapiInit(){if((typeof VK!="undefined")&&(typeof MD5!="undefined")){clearInterval(VKLOAD_intervel);VK.init(function(){loadParams(document.location.href);if((typeof this_proxy.params.api_result!="undefined")&&(this_proxy.params.api_result.indexOf("<?xml")!=0)){this_proxy.params.api_result=eval("("+this_proxy.params.api_result+")")}this_proxy.external=VK.External;this_proxy.callMethod=function(method){VK.callMethod.apply(VK,arguments)};this_proxy.addCallback=function(name,callback){if(typeof callbacks[name]=="undefined"){callbacks[name]=new Array()}callbacks[name].push(callback);VK.addCallback(name,function(){for(var c in callbacks[name]){if(callbacks[name][c]!=null){callbacks[name][c].apply(null,arguments)}}});return callbacks[name].length-1};this_proxy.removeCallback=function(name,callback_id){callbacks[name].splice(callback_id,1,null)};oninit()},function(){if(onfailure!=null){onfailure()}})}}};